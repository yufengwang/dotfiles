#!/usr/bin/env bash
#
# A simple dotfiles manager.

set -eu -o pipefail

NAME="dotfilez"
HOME="$(echo ~)"
ROOT_DIR="$HOME/.dotfiles"
BIN_DIR="$ROOT_DIR/bin"
SRC_DIR="$ROOT_DIR/dot"

print_help() {
  echo "$NAME - A simple CLI for dotfile management"
  echo "Usage: $NAME <command>"
  echo ""
  echo "Commands:"
  echo "    install    -  symlink dotfiles and install plugins"
  echo "    uninstall  -  unlink dotfiles"
  echo "    update     -  update submodules and plugins"
  echo "    help       -  display this help"
}

print_usage() {
  echo "Usage: $NAME <command>"
  echo "Try '$NAME help' for more info"
}

link_dotfiles() {
  cd "$SRC_DIR"
  printf '> symlinking dotfiles to %s\n' "$HOME"

  for match in ./*; do
    # grab only the filename
    local file="${match:2}"

    local src_file="$SRC_DIR/$file"
    local dest_file="$HOME/.$file"

    if [[ -L "$dest_file" ]]; then
      rm -rf "$dest_file"
      ln -s "$src_file" "$dest_file"
      printf '%s: symlink replaced\n' ".$file"
    elif [[ -e "$dest_file" ]]; then
      mv "$dest_file" "$dest_file.bkup"
      ln -s "$src_file" "$dest_file"
      printf '%s: backed up to %s\n' ".$file" ".$file.bkup"
    else
      ln -s "$src_file" "$dest_file"
      printf '%s: symlinked\n' ".$file"
    fi
  done
}

unlink_dotfiles() {
  cd "$SRC_DIR"
  printf '> unlinking dotfiles from %s\n' "$HOME"

  for match in ./*; do
    # grab only the filename
    local file="${match:2}"
    local dest_file="$HOME/.$file"

    if [[ -e "$dest_file" ]] && [[ -L "$dest_file" ]]; then
      rm -rf "$dest_file"
      printf '%s: unlinked\n' ".$file"
    fi
  done
}

setup_submodules() {
  cd "$ROOT_DIR"
  printf '> setting up submodules\n'
  git submodule init
  git submodule update
}

update_submodules() {
  cd "$ROOT_DIR"
  printf '> updating submodules\n'
  git submodule update --init
}

install_vim_plugins() {
  printf '> installing vim plugins\n'
  vim +PlugInstall
}

update_vim_plugins() {
  printf '> updating vim plugins\n'
  vim +PlugUpgrade
  vim +PlugUpdate
  vim +PlugClean
}

download_vim_plug() {
  curl -sfLo ~/.vim/autoload/plug.vim --create-dirs \
      https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
}

run_install() {
  setup_submodules
  link_dotfiles
  download_vim_plug
  install_vim_plugins
  printf '> install complete. please reboot your shell.\n'
}

run_uninstall() {
  unlink_dotfiles
  printf '> uninstall complete. please reboot your shell.\n'
}

run_update() {
  update_submodules
  update_vim_plugins
  printf '> update complete.\n'
}

main() {
  case "$1" in
    install)
      run_install
      ;;
    uninstall)
      run_uninstall
      ;;
    update)
      run_update
      ;;
    help)
      print_help
      ;;
    '')
      print_usage
      exit 1
      ;;
    *)
      echo "Unrecognized command. Try: '$NAME help'"
      exit 1
  esac
  exit 0
}

main "$@"
