#!/bin/bash
#
# A simple dotfiles manager.

NAME="dotfilez"
HOME="$(echo ~)"
USR_BIN="/usr/bin"
DOTFILES_ROOT="${HOME}/.dotfiles"
DOTFILES_BIN="${DOTFILES_ROOT}/bin"
DOTFILES_SRC="${DOTFILES_ROOT}/config"

print_help() {
  echo "${NAME} - A simple CLI for dotfile management"
  echo "Usage: ${NAME} <command>"
  echo ""
  echo "Commands:"
  echo "    install    -  symlink dotfiles, symlink this manager, and install plugins"
  echo "    uninstall  -  unlink dotfiles and unlink this manager"
  echo "    update     -  update submodules and plugins"
  echo "    help       -  display this help"
}

link_manager() {
  echo "Symlinking dotfiles manager to ${USR_BIN}... "
  sudo ln -sf ${DOTFILES_BIN}/${NAME} ${USR_BIN}/${NAME}
  echo "done"
}

unlink_manager() {
  echo "Unlinking dotfiles manager from ${USR_BIN}... "
  sudo rm -f ${USR_BIN}/${NAME}
  echo "done"
}

link_dotfiles() {
  cd ${DOTFILES_SRC}

  echo "Symlinking dotfiles to ${HOME}... "
  for match in ./*; do
    # grab only the filename
    local file="$(echo ${match:2})"

    if [[ -e "${HOME}/.${file}" ]] && [[ ! -L "${HOME}/.${file}" ]]; then
      echo "  .${file}: already exists, backing up to .${file}.old"
      mv ${HOME}/.${file} ${HOME}/.${file}.old
      ln -s ${DOTFILES_SRC}/${file} ${HOME}/.${file}
    elif [[ -e "${HOME}/.${file}" ]] && [[ -L "${HOME}/.${file}" ]]; then
      echo "  .${file}: symlink already exists, replacing"
      rm -rf ${HOME}/.${file}
      ln -s ${DOTFILES_SRC}/${file} ${HOME}/.${file}
    else
      echo "  .${file}: does not exist, symlinking"
      ln -s ${DOTFILES_SRC}/${file} ${HOME}/.${file}
    fi
  done
  echo "done"
}

unlink_dotfiles() {
  cd ${DOTFILES_SRC}

  echo "Unlinking dotfiles from ${HOME}... "
  for match in ./*; do
    # grab only the filename
    local file="$(echo ${match:2})"

    if [[ -e "${HOME}/.${file}" ]] && [[ -L "${HOME}/.${file}" ]]; then
      echo "  .${file}: unlinking"
      rm -rf ${HOME}/.${file}
    fi
  done
  echo "done"
}

setup_submodules() {
  cd ${DOTFILES_ROOT}

  echo "Setting up submodules... "
  git submodule init
  git submodule update
  echo "done"
}

update_submodules() {
  cd ${DOTFILES_ROOT}

  echo "Updating submodules... "
  git submodule update --init
  echo "done"
}

install_vim_plugins() {
  echo "Installing vim plugins... "
  vim +PluginInstall +qall
  echo "done"
}

update_vim_plugins() {
  echo "Updating vim plugins... "
  vim +PluginInstall! +qall
  echo "done"
}

main() {
  case "${1}" in
    install)
      setup_submodules
      echo ""
      link_dotfiles
      echo ""
      link_manager
      echo ""
      install_vim_plugins
      echo ""
      echo "Dotfiles from Zero to Hero is complete."
      echo "Please reboot your shell."
      ;;
    uninstall)
      unlink_dotfiles
      echo ""
      unlink_manager
      echo ""
      echo "Dotfiles uninstall complete."
      echo "Please reboot your shell."
      ;;
    update)
      update_submodules
      echo ""
      update_vim_plugins
      echo ""
      echo "Dotfiles update complete."
      ;;
    help)
      print_help
      ;;
    '')
      echo "${NAME} - A simple CLI for dotfile management"
      echo "Usage: ${NAME} <command>"
      echo ""
      echo "Try '${NAME} help' for more info"
      exit 1
      ;;
    *)
      echo "Unrecognized command. Try: ${NAME} help"
      exit 1
  esac
}

# execute the manager
main ${1}
exit 0
